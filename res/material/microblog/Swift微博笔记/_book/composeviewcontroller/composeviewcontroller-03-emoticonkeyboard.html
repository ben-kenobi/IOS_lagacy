<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>表情键盘 | 新浪微博笔记</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../composeviewcontroller/composeviewcontroller-04-nsattributedstring.html" />
    
    
    <link rel="prev" href="../composeviewcontroller/composeviewcontroller-02-selectedpicture.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book"  data-level="0.13.3" data-basepath=".." data-revision="1450373823090">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         新浪微博笔记
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.1" data-path="prepare/projectpreparation.html">
            
                
                    <a href="../prepare/projectpreparation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.</b>
                        
                         项目准备
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.1.1" data-path="prepare/oschina.html">
            
                
                    <a href="../prepare/oschina.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.1.</b>
                        
                         项目部署
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.1.2" data-path="prepare/basesetting.html">
            
                
                    <a href="../prepare/basesetting.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.2.</b>
                        
                         项目设置
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.1.2.1" data-path="prepare/imagesassets-icon_default.html">
            
                
                    <a href="../prepare/imagesassets-icon_default.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.2.1.</b>
                        
                         图标&amp;启动图
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.1.3" data-path="prepare/baseframework.html">
            
                
                    <a href="../prepare/baseframework.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.3.</b>
                        
                         基本架构
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.1.4" data-path="prepare/mvvm.html">
            
                
                    <a href="../prepare/mvvm.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.1.4.</b>
                        
                         MVVM
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.2" data-path="createproject/createproject.html">
            
                
                    <a href="../createproject/createproject.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.</b>
                        
                         项目搭建
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.2.1" data-path="createproject/createproject-01-createfiles.html">
            
                
                    <a href="../createproject/createproject-01-createfiles.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.1.</b>
                        
                         创建文件
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2.2" data-path="createproject/createproject-02-addchildcontrollers.html">
            
                
                    <a href="../createproject/createproject-02-addchildcontrollers.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.2.</b>
                        
                         添加子控制器
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2.3" data-path="createproject/createproject-03-tabbaritemsetting.html">
            
                
                    <a href="../createproject/createproject-03-tabbaritemsetting.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.3.</b>
                        
                         UITabBar调整
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2.4" data-path="createproject/createproject-04-costommaintabbar.html">
            
                
                    <a href="../createproject/createproject-04-costommaintabbar.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.4.</b>
                        
                         自定义UITabBar
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2.5" data-path="createproject/createproject-05-uiview+extension.html">
            
                
                    <a href="../createproject/createproject-05-uiview+extension.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.5.</b>
                        
                         Frame抽取
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.2.6" data-path="createproject/createproject-06-summary.html">
            
                
                    <a href="../createproject/createproject-06-summary.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.2.6.</b>
                        
                         小结
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.3" data-path="navigationsetting/navigationcontroller.html">
            
                
                    <a href="../navigationsetting/navigationcontroller.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.3.</b>
                        
                         导航栏设置
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.3.1" data-path="navigationsetting/ibinspectable&amp;ibdesignable.html">
            
                
                    <a href="../navigationsetting/ibinspectable&amp;ibdesignable.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.3.1.</b>
                        
                         发现页面搜索框
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.3.2" data-path="navigationsetting/customuibarbuttonitem.html">
            
                
                    <a href="../navigationsetting/customuibarbuttonitem.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.3.2.</b>
                        
                         UIBarButtonItem抽取
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.3.3" data-path="navigationsetting/customnavigationcontroller.html">
            
                
                    <a href="../navigationsetting/customnavigationcontroller.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.3.3.</b>
                        
                         自定义导航控制器
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.4" data-path="visitor/visitor.html">
            
                
                    <a href="../visitor/visitor.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.</b>
                        
                         访客视图
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.4.1" data-path="visitor/visitor-01-visitortableviewcontroller.html">
            
                
                    <a href="../visitor/visitor-01-visitortableviewcontroller.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.1.</b>
                        
                         表格视图控制器基类
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.4.2" data-path="visitor/visitor-02-userloginview.html">
            
                
                    <a href="../visitor/visitor-02-userloginview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.2.</b>
                        
                         用户登录视图
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.4.3" data-path="visitor/visitor-03-loginlogic.html">
            
                
                    <a href="../visitor/visitor-03-loginlogic.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.3.</b>
                        
                         设置未登录信息
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.4.4" data-path="visitor/visitor-04-homeanimation.html">
            
                
                    <a href="../visitor/visitor-04-homeanimation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.4.</b>
                        
                         首页动画
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.4.5" data-path="visitor/visitor-05-logindelegate.html">
            
                
                    <a href="../visitor/visitor-05-logindelegate.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.5.</b>
                        
                         登陆&amp;注册代理回调
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.4.6" data-path="visitor/visitor-06-summary.html">
            
                
                    <a href="../visitor/visitor-06-summary.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.4.6.</b>
                        
                         小结
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.5" data-path="frameworks/frameworks.html">
            
                
                    <a href="../frameworks/frameworks.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.5.</b>
                        
                         第三方框架
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.5.1" data-path="frameworks/afnetworking.html">
            
                
                    <a href="../frameworks/afnetworking.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.5.1.</b>
                        
                         AFNetworking
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.5.2" data-path="frameworks/svprogresshud sdwebimage.html">
            
                
                    <a href="../frameworks/svprogresshud sdwebimage.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.5.2.</b>
                        
                         SVProgressHUD 和 SDWebImage
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.5.3" data-path="frameworks/snapkit.html">
            
                
                    <a href="../frameworks/snapkit.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.5.3.</b>
                        
                         SnapKit
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.6" data-path="oauth/oauth.html">
            
                
                    <a href="../oauth/oauth.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.6.</b>
                        
                         OAuth
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.6.1" data-path="oauth/oauth-01-register.html">
            
                
                    <a href="../oauth/oauth-01-register.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.6.1.</b>
                        
                         注册应用程序
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.6.2" data-path="oauth/oauth-02-loadoauthpage.html">
            
                
                    <a href="../oauth/oauth-02-loadoauthpage.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.6.2.</b>
                        
                         加载授权页面
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.7" data-path="accesstoken/accesstoken.html">
            
                
                    <a href="../accesstoken/accesstoken.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.7.</b>
                        
                         Access Token
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.7.1" data-path="accesstoken/accesstoken-01-useraccount.html">
            
                
                    <a href="../accesstoken/accesstoken-01-useraccount.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.7.1.</b>
                        
                         用户帐户模型
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.7.2" data-path="accesstoken/accesstoken-02-expiresdate.html">
            
                
                    <a href="../accesstoken/accesstoken-02-expiresdate.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.7.2.</b>
                        
                         设置过期日期
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.7.3" data-path="accesstoken/account-03-loaduserinfo.html">
            
                
                    <a href="../accesstoken/account-03-loaduserinfo.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.7.3.</b>
                        
                         加载用户信息
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.7.4" data-path="accesstoken/accesstoken-03-useraccountarchive.html">
            
                
                    <a href="../accesstoken/accesstoken-03-useraccountarchive.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.7.4.</b>
                        
                         归档保存用户信息
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.7.5" data-path="accesstoken/accesstoken-05-viewmodel.html">
            
                
                    <a href="../accesstoken/accesstoken-05-viewmodel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.7.5.</b>
                        
                         视图模型
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.8" data-path="newfeature/newfeature.html">
            
                
                    <a href="../newfeature/newfeature.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.8.</b>
                        
                         新特性&amp;欢迎页
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.8.1" data-path="newfeature/newfeature-01-newfeature.html">
            
                
                    <a href="../newfeature/newfeature-01-newfeature.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.8.1.</b>
                        
                         新特性页
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.8.2" data-path="newfeature/newfeature-02-welcome.html">
            
                
                    <a href="../newfeature/newfeature-02-welcome.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.8.2.</b>
                        
                         欢迎页
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.8.3" data-path="newfeature/newfeature-03-switch_rootviewcontroller.html">
            
                
                    <a href="../newfeature/newfeature-03-switch_rootviewcontroller.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.8.3.</b>
                        
                         界面切换
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.9" data-path="homepage/homepage.html">
            
                
                    <a href="../homepage/homepage.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.</b>
                        
                         首页布局
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.9.1" data-path="homepage/homepage-01-statusmodel.html">
            
                
                    <a href="../homepage/homepage-01-statusmodel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.1.</b>
                        
                         微博数据模型
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.2" data-path="homepage/homepage-02-showintable.html">
            
                
                    <a href="../homepage/homepage-02-showintable.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.2.</b>
                        
                         显示表格数据
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.3" data-path="homepage/home-page-usermodel.html">
            
                
                    <a href="../homepage/home-page-usermodel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.3.</b>
                        
                         用户模型
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.4" data-path="homepage/homepage-04-statuscell.html">
            
                
                    <a href="../homepage/homepage-04-statuscell.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.4.</b>
                        
                         自定义 Cell
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.9.4.1" data-path="homepage/statuscell-01-originalview.html">
            
                
                    <a href="../homepage/statuscell-01-originalview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.4.1.</b>
                        
                         原创微博内容
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.4.2" data-path="homepage/statuscell-02-toolbar.html">
            
                
                    <a href="../homepage/statuscell-02-toolbar.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.4.2.</b>
                        
                         底部ToolBar
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.4.3" data-path="homepage/statuscell-03-retweetview.html">
            
                
                    <a href="../homepage/statuscell-03-retweetview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.4.3.</b>
                        
                         转发微博
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.4.4" data-path="homepage/statuscell-04-picture.html">
            
                
                    <a href="../homepage/statuscell-04-picture.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.4.4.</b>
                        
                         配图
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.9.4.5" data-path="homepage/statuscell-05-other.html">
            
                
                    <a href="../homepage/statuscell-05-other.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.9.4.5.</b>
                        
                         其他细节
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.10" data-path="refresh/refresh.html">
            
                
                    <a href="../refresh/refresh.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.10.</b>
                        
                         下拉刷新&amp;上拉加载
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.10.1" data-path="refresh/refresh-01-pullup.html">
            
                
                    <a href="../refresh/refresh-01-pullup.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.10.1.</b>
                        
                         上拉加载
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.10.2" data-path="refresh/refresh-pulldown.html">
            
                
                    <a href="../refresh/refresh-pulldown.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.10.2.</b>
                        
                         下拉刷新
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.10.3" data-path="refresh/refresh-pull_down_tips.html">
            
                
                    <a href="../refresh/refresh-pull_down_tips.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.10.3.</b>
                        
                         下拉刷新提示
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.11" data-path="creat_at&amp;source.html">
            
                
                    <a href="../creat_at&amp;source.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.11.</b>
                        
                         微博时间&amp;来源格式化
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.12" data-path="composeviewcontroller/compose_animation.html">
            
                
                    <a href="../composeviewcontroller/compose_animation.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.12.</b>
                        
                         撰写按钮点击动画
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.13" data-path="composeviewcontroller/composeviewcontroller.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.</b>
                        
                         发布微博
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.13.1" data-path="composeviewcontroller/composeviewcontroller-01-setupui.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-01-setupui.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.1.</b>
                        
                         界面搭建
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.13.2" data-path="composeviewcontroller/composeviewcontroller-02-selectedpicture.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-02-selectedpicture.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.2.</b>
                        
                         选择图片
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="0.13.3" data-path="composeviewcontroller/composeviewcontroller-03-emoticonkeyboard.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-03-emoticonkeyboard.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.3.</b>
                        
                         表情键盘
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.13.4" data-path="composeviewcontroller/composeviewcontroller-04-nsattributedstring.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-04-nsattributedstring.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.4.</b>
                        
                         图文混排
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.13.5" data-path="composeviewcontroller/composeviewcontroller-05-keyboardpopview.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-05-keyboardpopview.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.5.</b>
                        
                         表情点击气泡
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.13.6" data-path="composeviewcontroller/composeviewcontroller-06-recentemoticon.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-06-recentemoticon.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.6.</b>
                        
                         最近表情保存
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.13.7" data-path="composeviewcontroller/composeviewcontroller-07-sendstatus.html">
            
                
                    <a href="../composeviewcontroller/composeviewcontroller-07-sendstatus.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.13.7.</b>
                        
                         发布微博
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="0.14" data-path="home-attributedstring.html">
            
                
                    <a href="../home-attributedstring.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.14.</b>
                        
                         首页完善
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.15" data-path="appendix/appendix.html">
            
                
                    <a href="../appendix/appendix.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.15.</b>
                        
                         其他
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="0.15.1" data-path="appendix/alamofire.html">
            
                
                    <a href="../appendix/alamofire.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.15.1.</b>
                        
                         Alamofire
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.15.2" data-path="appendix/cocoa pod.html">
            
                
                    <a href="../appendix/cocoa pod.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.15.2.</b>
                        
                         cocoa pod
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="0.15.3" data-path="appendix/singleton.html">
            
                
                    <a href="../appendix/singleton.html">
                        <i class="fa fa-check"></i>
                        
                            <b>0.15.3.</b>
                        
                         单例
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >新浪微博笔记</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_241">
                    
                        <h1 id="">表情键盘</h1>
<p>在 <code>Compose</code> 文件夹下的 <code>View</code> 文件夹下新建文件夹 <code>EmoticonKeyboard</code>，表情键盘所涉及到的View都放在这个文件夹下</p>
<h2 id="">实现效果</h2>
<p><img src="../image/表情键盘效果图.png" alt=""></p>
<h2 id="">实现思路</h2>
<ol>
<li>从最简单的 View 开始做起</li>
<li>底部切换表情类型的 View 可以使用 <code>UIStackView</code> 来实现</li>
<li>表情显示的 View 可以使用 <code>UICollectionView</code> 实现</li>
<li>每一页表情对应一个 <code>Cell</code> 来表示</li>
<li>每一种表情对应 <code>UICollectionView</code> 中的一组</li>
</ol>
<h2 id="-hmemoticonkeyboard">自定义 <code>HMEmoticonKeyboard</code></h2>
<ul>
<li>自定义 <code>HMEmoticonKeyboard</code> 继承于 <code>UIView</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonKeyboard</span>: <span class="hljs-title">UIView</span> </span>{

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>(frame: <span class="hljs-type">CGRect</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(frame: frame)

        setupUI()
    }

    private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
        <span class="hljs-comment">// 设置背景颜色</span>
        backgroundColor = <span class="hljs-type">UIColor</span>(patternImage: <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"emoticon_keyboard_background"</span>)!)
    }

    required <span class="hljs-keyword">init</span>?(coder aDecoder: <span class="hljs-type">NSCoder</span>) {
        fatalError(<span class="hljs-string">"init(coder:) has not been implemented"</span>)
    }
}
</code></pre>
<ul>
<li>在 <code>HMComposeViewController</code> 中添加切换键盘的方法 <code>switchKeyboard</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 切换键盘</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">switchKeyboard</span><span class="hljs-params">()</span></span>{
}
</code></pre>
<ul>
<li>在点击 <code>HMComposeToolBar</code> 上的表情按钮的时候调用方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// MARK: - HMComposeToolBarDelegate</span>
<span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">composeToolBarButtonDidSelected</span><span class="hljs-params">(type: ComposeToolBarButtonType)</span> </span>{
    <span class="hljs-keyword">switch</span> type {
    <span class="hljs-keyword">case</span> ...
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Emoticon</span>:
        switchKeyboard()
    }
}
</code></pre>
<ul>
<li>懒加载键盘</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 键盘</span>
private lazy <span class="hljs-keyword">var</span> emoticonKeyboard: <span class="hljs-type">HMEmoticonKeyboard</span> = {
    <span class="hljs-keyword">let</span> keyboard = <span class="hljs-type">HMEmoticonKeyboard</span>()
    keyboard.size = <span class="hljs-type">CGSizeMake</span>(<span class="hljs-type">SCREENW</span>, <span class="hljs-number">216</span>)
    <span class="hljs-keyword">return</span> keyboard
}()
</code></pre>
<ul>
<li>切换键盘<ul>
<li>要用自己的 View 当成键盘可以设置 UITextView 的 <code>inputView</code>属性</li>
<li>如果 <code>inputView</code> 为 <code>nil</code> 代表当前是系统键盘</li>
<li>切换键盘之后需要重新成为第一响应者，键盘才能看到实时效果</li>
</ul>
</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 切换键盘</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">switchKeyboard</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// 先取消第一响应者</span>
    textView.resignFirstResponder()
    <span class="hljs-comment">// 切换键盘，如果是系统键盘就切换成表情键盘，否则就切换成系统键盘</span>
    textView.inputView = textView.inputView == <span class="hljs-built_in">nil</span> ? emoticonKeyboard : <span class="hljs-built_in">nil</span>
    <span class="hljs-comment">// 成为第一响应者，显示新切换出来的键盘</span>
    textView.becomeFirstResponder()
}
</code></pre>
<blockquote>
<p>运行测试：在点击键盘切换的时候 toolBar 会跳动，原因是点击切换键盘会先取消第一响应者，这个时候键盘要退下，toolBar 跟着往下移动。当键盘切换完了之后又变成第一响应者，这个时候 toolBar 还没有往下移动完毕，又需跟着键盘要往上移动，所以形成了这样的效果，解决方式：切换键盘在取消第一响应者的时候不执行动画</p>
</blockquote>
<ul>
<li>定义属性 <code>isToolBarAnim</code>，默认为 true</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 底部 toolBar 是否执行动画</span>
private <span class="hljs-keyword">var</span> isToolBarAnim = <span class="hljs-built_in">true</span>
</code></pre>
<ul>
<li>在键盘弹出的通过调用的方法判断是否执行</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 键盘 frame 改变通知调用的方法</span>
<span class="hljs-preprocessor">@objc</span> private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">keyboardWillChangeFrame</span><span class="hljs-params">(noti: NSNotification)</span></span>{

    <span class="hljs-comment">// 如果不执行动画，直接返回</span>
    <span class="hljs-keyword">if</span> !isToolBarAnim {
        <span class="hljs-keyword">return</span>
    }
   ...
}
</code></pre>
<ul>
<li>在切换键盘的时候，改变状态</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 切换键盘</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">switchKeyboard</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// 取消第一响应者不执行动画 ，置为 false</span>
    isToolBarAnim = <span class="hljs-built_in">false</span>
    <span class="hljs-comment">// 先取消第一响应者</span>
    textView.resignFirstResponder()

    <span class="hljs-comment">// 切换键盘，如果是系统键盘就切换成表情键盘，否则就切换成系统键盘</span>
    textView.inputView = textView.inputView == <span class="hljs-built_in">nil</span> ? emoticonKeyboard : <span class="hljs-built_in">nil</span>

    <span class="hljs-comment">// 切换 toolBar 图标状态</span>
    composeToolBar.isEmoticonKeyboard = textView.inputView != <span class="hljs-built_in">nil</span>
    <span class="hljs-comment">// 再次成为第一响应者执行动画 ，置为 true</span>
    isToolBarAnim = <span class="hljs-built_in">true</span>
    <span class="hljs-comment">// 成为第一响应者，显示新切换出来的键盘</span>
    textView.becomeFirstResponder()
}
</code></pre>
<ul>
<li><p>切换 toolBar 上键盘图标</p>
<ul>
<li>如果当前切换到系统键盘显示表情键盘图标</li>
<li>如果当前切换到表情键盘显示系统键盘图标</li>
</ul>
</li>
<li><p>在 <code>HMComposeToolBar</code> 中提供 <code>isEmoticonKeyboard</code></p>
</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 是否是显示的表情键盘</span>
<span class="hljs-keyword">var</span> isEmoticonKeyboard: <span class="hljs-type">Bool</span> = <span class="hljs-built_in">false</span> {
    <span class="hljs-keyword">didSet</span>{
        <span class="hljs-keyword">if</span> isEmoticonKeyboard {
            <span class="hljs-comment">// 显示系统键盘的图标</span>
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-comment">// 显示表情键盘的图标</span>
        }
    }
}
</code></pre>
<ul>
<li><p>在 <code>HMComposeToolBar</code> 添加子控件的时候记录表情切换按钮</p>
<ul>
<li>给 <code>addChildItem</code> 方法添加返回值</li>
<li>记录添加表情切换按钮</li>
</ul>
</li>
<li><p>添加返回值</p>
</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 添加子控件</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// - parameter imageName: 图片名字</span>
<span class="hljs-comment">/// - parameter type:      当前按钮的类型</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">addChildItem</span><span class="hljs-params">(imageName: String, type: ComposeToolBarButtonType)</span> -&gt; <span class="hljs-title">UIButton</span> </span>{
    ...
    <span class="hljs-keyword">return</span> button
}
</code></pre>
<ul>
<li>记录添加的表情键盘切换按钮</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 表情键盘切换按钮</span>
private <span class="hljs-keyword">var</span> emoticonButton: <span class="hljs-type">UIButton</span>?

...

<span class="hljs-comment">// 在添加的时候记录</span>
emoticonButton = addChildItem(<span class="hljs-string">"compose_emoticonbutton_background"</span>, type: .<span class="hljs-type">Emoticon</span>)
</code></pre>
<ul>
<li>完善 <code>isEmoticonKeyboard</code> 的 <code>didSet</code> 方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 是否是显示的表情键盘</span>
<span class="hljs-keyword">var</span> isEmoticonKeyboard: <span class="hljs-type">Bool</span> = <span class="hljs-built_in">false</span> {
    <span class="hljs-keyword">didSet</span>{
        <span class="hljs-comment">// 默认是表情按钮图标</span>
        <span class="hljs-keyword">var</span> imageName = <span class="hljs-string">"compose_emoticonbutton_background"</span>
        <span class="hljs-keyword">if</span> isEmoticonKeyboard {
            <span class="hljs-comment">// 显示系统键盘的图标</span>
            imageName = <span class="hljs-string">"compose_keyboardbutton_background"</span>
        }
        <span class="hljs-keyword">self</span>.emoticonButton!.setImage(<span class="hljs-type">UIImage</span>(named: imageName), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
        <span class="hljs-keyword">self</span>.emoticonButton!.setImage(<span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(imageName)</span>_highlighted"</span>), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Highlighted</span>)
    }
}
</code></pre>
<h2 id="">表情类型切换视图</h2>
<ul>
<li>自定义 <code>HMEmoticonToolBar</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonToolBar</span>: <span class="hljs-title">UIStackView</span> </span>{

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>(frame: <span class="hljs-type">CGRect</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(frame: frame)
        <span class="hljs-comment">// 设置布局方向</span>
        axis = <span class="hljs-type">UILayoutConstraintAxis</span>.<span class="hljs-type">Horizontal</span>
        <span class="hljs-comment">// 设置子控件的分布方式 -&gt; 填充，大小相等</span>
        distribution = <span class="hljs-type">UIStackViewDistribution</span>.<span class="hljs-type">FillEqually</span>

        setupUI()
    }

    private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
        <span class="hljs-comment">// 添加 4 个按钮</span>
    }

    required <span class="hljs-keyword">init</span>?(coder aDecoder: <span class="hljs-type">NSCoder</span>) {
        fatalError(<span class="hljs-string">"init(coder:) has not been implemented"</span>)
    }
}
</code></pre>
<ul>
<li>提供添加 4 个按钮的方法</li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">addChildItem</span><span class="hljs-params">(title: String, bgImageName: String)</span> </span>{
    <span class="hljs-keyword">let</span> button = <span class="hljs-type">UIButton</span>()

    <span class="hljs-comment">// 设置文字以及字体大小</span>
    button.titleLabel?.font = <span class="hljs-type">UIFont</span>.systemFontOfSize(<span class="hljs-number">14</span>)
    button.setTitle(title, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)

    <span class="hljs-comment">// 设置不同状态的背景图片</span>
    button.setBackgroundImage(<span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(bgImageName)</span>_normal"</span>), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
    button.setBackgroundImage(<span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(bgImageName)</span>_selected"</span>), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Selected</span>)

    <span class="hljs-comment">// 设置不同状态的文字颜色</span>
    button.setTitleColor(<span class="hljs-type">UIColor</span>.whiteColor(), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
    button.setTitleColor(<span class="hljs-type">UIColor</span>.grayColor(), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Selected</span>)

    addArrangedSubview(button)
}
</code></pre>
<ul>
<li>在 <code>setupUI</code> 中添加按钮</li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// 添加 4 个按钮</span>
    addChildItem(<span class="hljs-string">"最近"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_left"</span>)
    addChildItem(<span class="hljs-string">"默认"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_mid"</span>)
    addChildItem(<span class="hljs-string">"Emoji"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_mid"</span>)
    addChildItem(<span class="hljs-string">"浪小花"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_right"</span>)
}
</code></pre>
<ul>
<li>在 <code>HMEmoiticonKeyboard</code> 中添加 <code>HMEmoticonToolBar</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// 懒加载控件</span>
<span class="hljs-comment">/// 底部切换表情类型的toolBar</span>
private lazy <span class="hljs-keyword">var</span> emoticonToolBar: <span class="hljs-type">HMEmoticonToolBar</span> = <span class="hljs-type">HMEmoticonToolBar</span>(frame: <span class="hljs-type">CGRectZero</span>)
</code></pre>
<ul>
<li>在 <code>setupUI</code> 方法中添加控件以及约束</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// 添加子控件</span>
addSubview(emoticonToolBar)

<span class="hljs-comment">// 添加约束</span>
emoticonToolBar.snp_makeConstraints { (make) -&gt; <span class="hljs-type">Void</span> <span class="hljs-keyword">in</span>
    make.bottom.equalTo(<span class="hljs-keyword">self</span>.snp_bottom)
    make.leading.equalTo(<span class="hljs-keyword">self</span>.snp_leading)
    make.<span class="hljs-keyword">right</span>.equalTo(<span class="hljs-keyword">self</span>.snp_right)
    make.height.equalTo(<span class="hljs-number">37</span>)
}
</code></pre>
<blockquote>
<p>运行测试：按钮背景图片没有拉伸方式有问题</p>
</blockquote>
<ul>
<li><p>更改拉伸方式：点击Assets.xcassets --&gt; 选中对应的背景图片 --&gt; 查看右边属性面板 --&gt; 在 <code>Slicing</code> 区设置 <code>Slices</code> 为 <code>Horizontal</code>，设置 <code>center</code> 为 <code>Stretches</code></p>
<ul>
<li>有些情况下 Xcode 会出 Bug，需要设置 <code>Slices</code> 为 <code>Horizontal And Vertical</code></li>
</ul>
</li>
<li><p>监听子按钮点击</p>
</li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">addChildItem</span><span class="hljs-params">(title: String, bgImageName: String)</span> </span>{
    <span class="hljs-keyword">let</span> button = <span class="hljs-type">UIButton</span>()
    <span class="hljs-comment">// 添加点击事件</span>
    button.addTarget(<span class="hljs-keyword">self</span>, action: <span class="hljs-string">"childButtonClick:"</span>, forControlEvents: <span class="hljs-type">UIControlEvents</span>.<span class="hljs-type">TouchUpInside</span>)
    ...
}
</code></pre>
<ul>
<li>实现响应方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 子控件点击</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// - parameter button: 当前点击的 button</span>
<span class="hljs-preprocessor">@objc</span> private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">childButtonClick</span><span class="hljs-params">(button: UIButton)</span></span>{
    <span class="hljs-comment">// 按钮点击方法</span>
}
</code></pre>
<ul>
<li><p>实现选中一个按钮的时候取消选中之前的按钮</p>
<ul>
<li>记录当前选中的按钮</li>
<li>当点击下一个按钮的时候取消选中记录的按钮，选中当前按钮</li>
<li>再次记录当前选中的按钮</li>
</ul>
</li>
<li><p>定义 <code>currentSelectedButton</code> 属性记录当前选中的按钮</p>
</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 当前选中的按钮</span>
<span class="hljs-keyword">var</span> currentSelectedButton: <span class="hljs-type">UIButton</span>?
</code></pre>
<ul>
<li>在 <code>childButtonClick</code> 实现按钮点击逻辑</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 子按钮点击</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// - parameter button: 当前点击的 button</span>
<span class="hljs-preprocessor">@objc</span> private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">childButtonClick</span><span class="hljs-params">(button: UIButton)</span></span>{

    <span class="hljs-comment">// 如果当前选中的 button 与即将要选中的button相同，则直接返回</span>
    <span class="hljs-keyword">if</span> button == currentSelectedButton {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 取消选中之前的</span>
    currentSelectedButton?.selected = <span class="hljs-built_in">false</span>
    <span class="hljs-comment">// 选中现在点击的</span>
    button.selected = <span class="hljs-built_in">true</span>
    <span class="hljs-comment">// 再次记录现在选的按钮</span>
    currentSelectedButton = button
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<ul>
<li><p>按钮点击的时候需要让 <code>HMEmoticonKeyboard</code> 知道哪一个按钮点击了</p>
<ul>
<li>使用枚举区分是哪一个按钮点击</li>
<li>在添加按钮的时候传入对应的枚举值</li>
<li>将对应的枚举值设置成按钮的 <code>tag</code></li>
<li>添加协议，在按钮点击的时候调用协议方法</li>
</ul>
</li>
<li><p>定义枚举</p>
</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">HMEmoticonType</span>: <span class="hljs-title">Int</span> </span>{
    <span class="hljs-keyword">case</span> <span class="hljs-type">Recent</span> = <span class="hljs-number">0</span>      <span class="hljs-comment">// 最近表情</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Default</span> = <span class="hljs-number">1</span>     <span class="hljs-comment">// 默认表情</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Emoji</span> = <span class="hljs-number">2</span>       <span class="hljs-comment">// Emoji表情</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Lxh</span> = <span class="hljs-number">3</span>         <span class="hljs-comment">// 浪小花表情</span>
}
</code></pre>
<ul>
<li>扩展添加子按钮的方法，添加枚举参数，并设置 <code>tag</code></li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">addChildItem</span><span class="hljs-params">(title: String, bgImageName: String, type: HMEmoticonType)</span> </span>{
    <span class="hljs-keyword">let</span> button = <span class="hljs-type">UIButton</span>()
    <span class="hljs-comment">// 设置按钮的tag</span>
    button.tag = type.rawValue
    ...
}
</code></pre>
<ul>
<li>更新 <code>setupUI</code> 方法中调用方式</li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// 添加 4 个按钮</span>
    addChildItem(<span class="hljs-string">"最近"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_left"</span>, type: .<span class="hljs-type">Recent</span>)
    addChildItem(<span class="hljs-string">"默认"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_mid"</span>, type: .<span class="hljs-type">Default</span>)
    addChildItem(<span class="hljs-string">"Emoji"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_mid"</span>, type: .<span class="hljs-type">Emoji</span>)
    addChildItem(<span class="hljs-string">"浪小花"</span>, bgImageName: <span class="hljs-string">"compose_emotion_table_right"</span>, type: .<span class="hljs-type">Lxh</span>)
}
</code></pre>
<ul>
<li>定义协议</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">protocol</span> <span class="hljs-title">HMEmoticonToolBarDelegate</span>: <span class="hljs-title">NSObjectProtocol</span> </span>{
    <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">emoticonToolBarButtonDidSelected</span><span class="hljs-params">(type: HMEmoticonType)</span>
}</span>
</code></pre>
<ul>
<li>添加代理属性</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 代理</span>
<span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">HMEmoticonToolBarDelegate</span>?
</code></pre>
<ul>
<li>在按钮点击的时候调用代理身上的方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 子按钮点击</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// - parameter button: 当前点击的 button</span>
<span class="hljs-preprocessor">@objc</span> private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">childButtonClick</span><span class="hljs-params">(button: UIButton)</span></span>{
    ...
    <span class="hljs-comment">// 调用代理方法</span>
    delegate?.emoticonToolBarButtonDidSelected(<span class="hljs-type">HMEmoticonType</span>(rawValue: button.tag)!)
}
</code></pre>
<ul>
<li><code>HMEmoticonKeyboard</code> 继承 <code>HMEmoticonToolBarDelegate</code> 协议</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonKeyboard</span>: <span class="hljs-title">UIView</span>, <span class="hljs-title">HMEmoticonToolBarDelegate</span> </span>{
    ...
}
</code></pre>
<ul>
<li>在 <code>HMEmoticonKeyboard</code> 中设置 <code>HMEmoticonToolBar</code> 的代理为自己</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 底部切换表情类型的toolBar</span>
private lazy <span class="hljs-keyword">var</span> emoticonToolBar: <span class="hljs-type">HMEmoticonToolBar</span> = {
    <span class="hljs-keyword">let</span> toolBar = <span class="hljs-type">HMEmoticonToolBar</span>(frame: <span class="hljs-type">CGRectZero</span>)
    toolBar.delegate = <span class="hljs-keyword">self</span>
    <span class="hljs-keyword">return</span> toolBar
}()
</code></pre>
<ul>
<li>实现代理方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// MARK: - HMEmoticonToolBarDelegate</span>
<span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">emoticonToolBarButtonDidSelected</span><span class="hljs-params">(type: HMEmoticonType)</span> </span>{
    <span class="hljs-keyword">switch</span> type {
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Recent</span>:
        printLog(<span class="hljs-string">"最近"</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Default</span>:
        printLog(<span class="hljs-string">"默认"</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Emoji</span>:
        printLog(<span class="hljs-string">"Emoji"</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Lxh</span>:
        printLog(<span class="hljs-string">"浪小花"</span>)
    }
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<h2 id="">表情显示视图</h2>
<ul>
<li>在 <code>HMEmoticonKeyboard</code> 中添加 <code>UICollectionView</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 懒加载控件</span>
<span class="hljs-comment">/// 显示表情的视图</span>
private lazy <span class="hljs-keyword">var</span> emoticonCollectionView: <span class="hljs-type">UICollectionView</span> = {
    <span class="hljs-keyword">let</span> collectionView = <span class="hljs-type">UICollectionView</span>(frame: <span class="hljs-type">CGRectZero</span>, collectionViewLayout: <span class="hljs-type">UICollectionViewFlowLayout</span>())
    collectionView.backgroundColor = <span class="hljs-type">RandomColor</span>()
    <span class="hljs-keyword">return</span> collectionView
}()
</code></pre>
<ul>
<li>添加控件与约束</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// 添加子控件</span>
addSubview(emoticonCollectionView)
<span class="hljs-comment">// 添加约束</span>
emoticonCollectionView.snp_makeConstraints { (make) -&gt; <span class="hljs-type">Void</span> <span class="hljs-keyword">in</span>
    make.width.equalTo(<span class="hljs-keyword">self</span>.snp_width)
    make.top.equalTo(<span class="hljs-keyword">self</span>.snp_top)
    make.bottom.equalTo(<span class="hljs-keyword">self</span>.emoticonToolBar.snp_top)
    make.leading.equalTo(<span class="hljs-keyword">self</span>)
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<ul>
<li>设置 <code>emoticonCollectionView</code> 的数据源以及注册 cell</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 显示表情的视图</span>
private lazy <span class="hljs-keyword">var</span> emoticonCollectionView: <span class="hljs-type">UICollectionView</span> = {
    <span class="hljs-keyword">let</span> collectionView = <span class="hljs-type">UICollectionView</span>(frame: <span class="hljs-type">CGRectZero</span>, collectionViewLayout: <span class="hljs-type">UICollectionViewFlowLayout</span>())
    collectionView.backgroundColor = <span class="hljs-type">RandomColor</span>()
    <span class="hljs-comment">// 设置数据源</span>
    collectionView.dataSource = <span class="hljs-keyword">self</span>
    <span class="hljs-comment">// 注册 cell</span>
    collectionView.registerClass(<span class="hljs-type">UICollectionViewCell</span>.<span class="hljs-keyword">self</span>, forCellWithReuseIdentifier: <span class="hljs-type">HMEmoticonKeyboardCellId</span>)
    <span class="hljs-keyword">return</span> collectionView
}()
</code></pre>
<ul>
<li>继承协议</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonKeyboard</span>: <span class="hljs-title">UIView</span>, <span class="hljs-title">HMEmoticonToolBarDelegate</span>, <span class="hljs-title">UICollectionViewDataSource</span> </span>{
    ...
}
</code></pre>
<ul>
<li>实现协议方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">HMEmoticonKeyboard</span> </span>{

    <span class="hljs-comment">/// 返回表情一共有多少页</span>
    <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">collectionView</span><span class="hljs-params">(collectionView: UICollectionView, numberOfItemsInSection section: Int)</span> -&gt; <span class="hljs-title">Int</span> </span>{
        <span class="hljs-comment">// 为了测试，先默认返回10个</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>
    }

    <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">collectionView</span><span class="hljs-params">(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath)</span> -&gt; <span class="hljs-title">UICollectionViewCell</span> </span>{
        <span class="hljs-keyword">let</span> cell = collectionView.dequeueReusableCellWithReuseIdentifier(<span class="hljs-type">HMEmoticonKeyboardCellId</span>, forIndexPath: indexPath)
        <span class="hljs-comment">// 测试返回随机颜色</span>
        cell.backgroundColor = <span class="hljs-type">RandomColor</span>()
        <span class="hljs-keyword">return</span> cell
    }
}
</code></pre>
<blockquote>
<p>运行测试：</p>
</blockquote>
<ul>
<li>调整每一个 cell 的大小<ul>
<li>因为每一个 <code>cell</code> 的大小与 <code>collectionView</code> 一样大</li>
<li>而调整完 collectionView 大小要调用的方法就是 <code>layoutSubviews</code></li>
<li>所以在 <code>layoutSubviews</code> 调整每一个 cell 的大小</li>
</ul>
</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">override</span> <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">layoutSubviews</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">super</span>.layoutSubviews()

    <span class="hljs-comment">// 设置每一个 cell 的大小</span>
    <span class="hljs-keyword">let</span> layout = emoticonCollectionView.collectionViewLayout <span class="hljs-keyword">as</span>! <span class="hljs-type">UICollectionViewFlowLayout</span>
    layout.itemSize = emoticonCollectionView.size
}
</code></pre>
<blockquote>
<p>运行测试：每一行之间有间距，而且滚动方向不对</p>
</blockquote>
<ul>
<li>在初始化 <code>emoticonCollectionView</code> 的时候设置滚动方向以及 cell 间距 （<code>UICollectionViewFlowLayout</code> 身上的属性）</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 显示表情的视图</span>
private lazy <span class="hljs-keyword">var</span> emoticonCollectionView: <span class="hljs-type">UICollectionView</span> = {
    <span class="hljs-keyword">let</span> layout = <span class="hljs-type">UICollectionViewFlowLayout</span>()
    <span class="hljs-comment">// 设置滚动方向：水平滚动</span>
    layout.scrollDirection = <span class="hljs-type">UICollectionViewScrollDirection</span>.<span class="hljs-type">Horizontal</span>
    <span class="hljs-comment">// 设置每一个 cell 之间的间距</span>
    layout.minimumLineSpacing = <span class="hljs-number">0</span>

    <span class="hljs-keyword">let</span> collectionView = <span class="hljs-type">UICollectionView</span>(frame: <span class="hljs-type">CGRectZero</span>, collectionViewLayout: layout)
    collectionView.backgroundColor = <span class="hljs-type">RandomColor</span>()
    <span class="hljs-comment">// 设置数据源</span>
    collectionView.dataSource = <span class="hljs-keyword">self</span>
    <span class="hljs-comment">// 注册 cell</span>
    collectionView.registerClass(<span class="hljs-type">UICollectionViewCell</span>.<span class="hljs-keyword">self</span>, forCellWithReuseIdentifier: <span class="hljs-type">HMEmoticonKeyboardCellId</span>)
    <span class="hljs-keyword">return</span> collectionView
}()
</code></pre>
<ul>
<li>开启分页 &amp; 隐藏水平滚动条 &amp; 关闭弹簧效果 (<code>UIScrollView</code> 身上的属性)</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// 开启分页 &amp; 隐藏水平滚动条</span>
collectionView.pagingEnabled = <span class="hljs-built_in">true</span>
collectionView.showsHorizontalScrollIndicator = <span class="hljs-built_in">false</span>
<span class="hljs-comment">// 关闭弹簧效果</span>
collectionView.bounces = <span class="hljs-built_in">false</span>
</code></pre>
<ul>
<li>自定义 <code>HMEmoticonPageCell</code> 为表情键盘的 Cell</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonPageCell</span>: <span class="hljs-title">UICollectionViewCell</span> </span>{

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>(frame: <span class="hljs-type">CGRect</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(frame: frame)

        setupUI()
    }

    required <span class="hljs-keyword">init</span>?(coder aDecoder: <span class="hljs-type">NSCoder</span>) {
        fatalError(<span class="hljs-string">"init(coder:) has not been implemented"</span>)
    }

    private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
        backgroundColor = <span class="hljs-type">RandomColor</span>()
    }
}
</code></pre>
<ul>
<li>替换注册的 cell</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// 注册 cell</span>
collectionView.registerClass(<span class="hljs-type">HMEmoticonPageCell</span>.<span class="hljs-keyword">self</span>, forCellWithReuseIdentifier: <span class="hljs-type">HMEmoticonKeyboardCellId</span>)
</code></pre>
<ul>
<li>为了测试效果，在 <code>HMEmoticonPageCell</code>中添加一个测试的 label</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonPageCell</span>: <span class="hljs-title">UICollectionViewCell</span> </span>{

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">init</span>(frame: <span class="hljs-type">CGRect</span>) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>(frame: frame)

        setupUI()
    }

    private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{

        contentView.addSubview(label)

        label.snp_makeConstraints { (make) -&gt; <span class="hljs-type">Void</span> <span class="hljs-keyword">in</span>
            make.center.equalTo(contentView.snp_center)
        }
    }

    required <span class="hljs-keyword">init</span>?(coder aDecoder: <span class="hljs-type">NSCoder</span>) {
        fatalError(<span class="hljs-string">"init(coder:) has not been implemented"</span>)
    }

    <span class="hljs-comment">/// 测试用的 label</span>
    private lazy <span class="hljs-keyword">var</span> label: <span class="hljs-type">UILabel</span> = {
        <span class="hljs-keyword">let</span> label = <span class="hljs-type">UILabel</span>()
        label.font = <span class="hljs-type">UIFont</span>.systemFontOfSize(<span class="hljs-number">35</span>)
        <span class="hljs-keyword">return</span> label
    }()
}
</code></pre>
<ul>
<li>提供 <code>indexPath: NSIndexPath</code> 属性，显示当前滚动到哪个位置</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">var</span> indexPath: <span class="hljs-type">NSIndexPath</span>? {
    <span class="hljs-keyword">didSet</span>{
        label.text = <span class="hljs-string">"第<span class="hljs-subst">\(indexPath!.section)</span>组，第<span class="hljs-subst">\(indexPath!.item)</span>页"</span>
    }
}
</code></pre>
<ul>
<li>在返回 cell 的时候设置 <code>indexPath</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">collectionView</span><span class="hljs-params">(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath)</span> -&gt; <span class="hljs-title">UICollectionViewCell</span> </span>{
    <span class="hljs-keyword">let</span> cell = collectionView.dequeueReusableCellWithReuseIdentifier(<span class="hljs-type">HMEmoticonKeyboardCellId</span>, forIndexPath: indexPath) <span class="hljs-keyword">as</span>! <span class="hljs-type">HMEmoticonPageCell</span>
    <span class="hljs-comment">// 测试返回随机颜色</span>
    cell.backgroundColor = <span class="hljs-type">RandomColor</span>()
    cell.indexPath = indexPath
    <span class="hljs-keyword">return</span> cell
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<h2 id="">读取表情数据</h2>
<ul>
<li>拖入 <code>Emoticons.bundle</code> 到项目中，其目录结构</li>
</ul>
<p><img src="../image/EmoticonBundle目录结构.png" alt=""></p>
<ul>
<li>新键 <code>HMEmoticonTools</code> 类，里面存放与表情操作相关的逻辑</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticonTools</span>: <span class="hljs-title">NSObject</span> </span>{
}
</code></pre>
<ul>
<li>定义表情模型</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HMEmoticon</span>: <span class="hljs-title">NSObject</span> </span>{

    <span class="hljs-comment">/// 表情文字描述</span>
    <span class="hljs-keyword">var</span> chs: <span class="hljs-type">String</span>?
    <span class="hljs-comment">/// 表情图片名字 (仅对图片表情有效)</span>
    <span class="hljs-keyword">var</span> png: <span class="hljs-type">String</span>?
    <span class="hljs-comment">/// 表情类型 0：图片表情 1: Emoji表情</span>
    <span class="hljs-keyword">var</span> type: <span class="hljs-type">Int</span> = <span class="hljs-number">0</span> {
        <span class="hljs-keyword">didSet</span>{
            <span class="hljs-keyword">self</span>.isEmoji = type == <span class="hljs-number">1</span>
        }
    }

    <span class="hljs-comment">/// Emoji表情的 code</span>
    <span class="hljs-keyword">var</span> code: <span class="hljs-type">String</span>?
    <span class="hljs-comment">/// 是否是Emoji表情</span>
    <span class="hljs-keyword">var</span> isEmoji: <span class="hljs-type">Bool</span> = <span class="hljs-built_in">false</span>

    <span class="hljs-keyword">init</span>(dictionary: [<span class="hljs-type">String</span>: <span class="hljs-type">AnyObject</span>]) {
        <span class="hljs-keyword">super</span>.<span class="hljs-keyword">init</span>()
        setValuesForKeysWithDictionary(dictionary)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setValue</span><span class="hljs-params">(value: AnyObject?, forUndefinedKey key: String)</span> </span>{}
}
</code></pre>
<ul>
<li>提供 <code>HMEmoticonTools</code> 单例</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 全局访问入口</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shareTools: <span class="hljs-type">HMEmoticonTools</span> = <span class="hljs-type">HMEmoticonTools</span>()
</code></pre>
<ul>
<li>读取表情 Bundle 文件</li>
</ul>
<pre><code class="lang-swift">private lazy <span class="hljs-keyword">var</span> emoticonBundle: <span class="hljs-type">NSBundle</span> = {
    <span class="hljs-keyword">let</span> bundle = <span class="hljs-type">NSBundle</span>(path: <span class="hljs-type">NSBundle</span>.mainBundle().pathForResource(<span class="hljs-string">"Emoticons.bundle"</span>, ofType: <span class="hljs-built_in">nil</span>)!)
    <span class="hljs-keyword">return</span> bundle!
}()
</code></pre>
<ul>
<li>读取默认表情数据（在 <code>HMEmoticonTools</code> 添加懒加载属性）</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 默认表情</span>
lazy <span class="hljs-keyword">var</span> defaultEmoticons: [<span class="hljs-type">HMEmoticon</span>] = {

    <span class="hljs-comment">// 通过文件名或者到文字路径</span>
    <span class="hljs-keyword">let</span> file = emoticonBundle.pathForResource(<span class="hljs-string">"default/info.plist"</span>, ofType: <span class="hljs-built_in">nil</span>)
    <span class="hljs-comment">// 加载数据</span>
    <span class="hljs-keyword">let</span> infoArray = <span class="hljs-type">NSArray</span>(contentsOfFile: file!)

    <span class="hljs-comment">// 字典转模型</span>
    <span class="hljs-keyword">var</span> result = [<span class="hljs-type">HMEmoticon</span>]()
    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> infoArray! {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> dic = (value <span class="hljs-keyword">as</span>? [<span class="hljs-type">String</span>: <span class="hljs-type">AnyObject</span>]) {
            <span class="hljs-keyword">let</span> emoticon = <span class="hljs-type">HMEmoticon</span>(dictionary: dic)
            result.append(emoticon)
        }
    }
    <span class="hljs-keyword">return</span> result
}()
</code></pre>
<ul>
<li>加载其他表情的方法类似，所以提取一个加载表情集合的方法</li>
</ul>
<pre><code class="lang-swift">/// 通过表情路径加载表情数据
/// - parameter path: 表情路径，如：default/info.plist
private func emoticons(path: String) -&gt; [HMEmoticon] {

    // 通过文件名或者到文字路径
    let file = emoticonBundle.pathForResource(path, ofType: nil)
    // 加载数据
    let infoArray = NSArray(contentsOfFile: file!)

    // 字典转模型
    var result = [HMEmoticon]()
    for value in infoArray! {
        if let dic = (value as? [String: AnyObject]) {
            let emoticon = HMEmoticon(dictionary: dic)
            result.append(emoticon)
        }
    }
    return result
}
</code></pre>
<ul>
<li>加载表情代码抽取如下</li>
</ul>
<pre><code class="lang-swift">
<span class="hljs-comment">/// 最近表情</span>
private lazy <span class="hljs-keyword">var</span> recentEmoticons: [<span class="hljs-type">HMEmoticon</span>] = [<span class="hljs-type">HMEmoticon</span>]()

<span class="hljs-comment">/// 默认表情</span>
private lazy <span class="hljs-keyword">var</span> defaultEmoticons: [<span class="hljs-type">HMEmoticon</span>] = {
    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">self</span>.emoticons(<span class="hljs-string">"default/info.plist"</span>)
    <span class="hljs-keyword">return</span> result
}()

<span class="hljs-comment">/// emoji表情</span>
private lazy <span class="hljs-keyword">var</span> emojiEmoticons: [<span class="hljs-type">HMEmoticon</span>] = {
    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">self</span>.emoticons(<span class="hljs-string">"emoji/info.plist"</span>)
    <span class="hljs-keyword">return</span> result
}()

<span class="hljs-comment">/// lxh表情</span>
private lazy <span class="hljs-keyword">var</span> lxhEmoticons: [<span class="hljs-type">HMEmoticon</span>] = {
    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">self</span>.emoticons(<span class="hljs-string">"lxh/info.plist"</span>)
    <span class="hljs-keyword">return</span> result
}()
</code></pre>
<ul>
<li>返回 <code>HMEmoticonKeyboard</code> 中 <code>collectionView</code> 所需要的数据<ul>
<li>数据结构分析如下</li>
</ul>
</li>
</ul>
<p><img src="../image/表情数据结构分析.png" alt=""></p>
<ul>
<li>在 <code>HMEmoticonTools</code> 中提供方法返回我们需要用的表情数组格式 (<code>伪代码</code>)</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 所有表情</span>
lazy <span class="hljs-keyword">var</span> allEmoticons: [[[<span class="hljs-type">HMEmoticon</span>]]] = {
    <span class="hljs-keyword">return</span> [
        最近表情分页后的二维数组,
        默认表情分页后的二维数组,
        <span class="hljs-type">Emoji</span>表情分页后的二维数组,
        浪小花表情分页后的二维数组
    ]
}
</code></pre>
<ul>
<li>提供返回 <code>某一种表情分页后的二维数组</code> 的方法</li>
</ul>
<pre><code class="lang-swift"> /// 返回某种类型表情集合，集合中装有每一页需要显示的表情集合
///
/// - parameter emoticons: 某种类型的表情集合
private func typeEmoticonPages(emoticons: [HMEmoticon]) -&gt; [[HMEmoticon]] {

    // 计算出当前传入表情一共有多少页
    let pageCount = (emoticons.count - 1) / HMEmoticonPageNum + 1

    // 初始化返回值
    var result = [[HMEmoticon]]()

    // 遍历截取子数组
    for i in 0..&lt;pageCount {

        let location = i * HMEmoticonPageNum
        var length = HMEmoticonPageNum
        // 判断是否截取到最后一页数组越界的问题
        if location + length &gt; emoticons.count {
            //代表数组越界了
            length = emoticons.count - location
        }
        // 截取子数组
        let pageEmotions = (emoticons as NSArray).subarrayWithRange(NSMakeRange(location, length)) as! [HMEmoticon]
        result.append(pageEmotions)
    }
    return result
}
</code></pre>
<blockquote>
<p>注意：需要判断数组越界</p>
</blockquote>
<ul>
<li>返回表情数据的方法更新为</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 所有表情</span>
lazy <span class="hljs-keyword">var</span> allEmoticons: [[[<span class="hljs-type">HMEmoticon</span>]]] = {
    <span class="hljs-keyword">return</span> [
        <span class="hljs-keyword">self</span>.typeEmoticonPages(<span class="hljs-keyword">self</span>.recentEmoticons),
        <span class="hljs-keyword">self</span>.typeEmoticonPages(<span class="hljs-keyword">self</span>.defaultEmoticons),
        <span class="hljs-keyword">self</span>.typeEmoticonPages(<span class="hljs-keyword">self</span>.emojiEmoticons),
        <span class="hljs-keyword">self</span>.typeEmoticonPages(<span class="hljs-keyword">self</span>.lxhEmoticons)
    ]
}()
</code></pre>
<ul>
<li>在 <code>HMEmoticonKeyboard</code> 中更改 <code>collectionView</code> 数据源方法的实现</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">extension</span> <span class="hljs-title">HMEmoticonKeyboard</span> </span>{

    <span class="hljs-comment">/// 返回一共有多少组表情</span>
    <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">numberOfSectionsInCollectionView</span><span class="hljs-params">(collectionView: UICollectionView)</span> -&gt; <span class="hljs-title">Int</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-type">HMEmoticonTools</span>.shareTools.allEmoticons.<span class="hljs-built_in">count</span>
    }

    <span class="hljs-comment">/// 返回每一种表情一共有多少页</span>
    <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">collectionView</span><span class="hljs-params">(collectionView: UICollectionView, numberOfItemsInSection section: Int)</span> -&gt; <span class="hljs-title">Int</span> </span>{
        <span class="hljs-comment">// 为了测试，先默认返回10个</span>
        <span class="hljs-keyword">return</span> <span class="hljs-type">HMEmoticonTools</span>.shareTools.allEmoticons[section].<span class="hljs-built_in">count</span>
    }

    <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">collectionView</span><span class="hljs-params">(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath)</span> -&gt; <span class="hljs-title">UICollectionViewCell</span> </span>{
        <span class="hljs-keyword">let</span> cell = collectionView.dequeueReusableCellWithReuseIdentifier(<span class="hljs-type">HMEmoticonKeyboardCellId</span>, forIndexPath: indexPath) <span class="hljs-keyword">as</span>! <span class="hljs-type">HMEmoticonPageCell</span>
        <span class="hljs-comment">// 测试返回随机颜色</span>
        cell.backgroundColor = <span class="hljs-type">RandomColor</span>()
        cell.indexPath = indexPath
        <span class="hljs-keyword">return</span> cell
    }
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<h2 id="-hmemoticontoolbar---collectionview-">底部 <code>HMEmoticonToolBar</code> 与 显示表情的 <code>collectionView</code> 联动</h2>
<h3 id="">点击底部表情类型按钮，切换到对应表情</h3>
<ul>
<li>在 <code>HMEmoticonToolBar</code> 的代表方法中使用 <code>collectionView</code> 滚动到对应的组</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">// MARK: - HMEmoticonToolBarDelegate</span>
<span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">emoticonToolBarButtonDidSelected</span><span class="hljs-params">(type: HMEmoticonType)</span> </span>{
    <span class="hljs-keyword">let</span> indexPath: <span class="hljs-type">NSIndexPath</span>
    <span class="hljs-keyword">switch</span> type {
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Recent</span>:<span class="hljs-comment">// 默认表情 第0组</span>
        indexPath = <span class="hljs-type">NSIndexPath</span>(forRow: <span class="hljs-number">0</span>, inSection: <span class="hljs-number">0</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Default</span>:
        indexPath = <span class="hljs-type">NSIndexPath</span>(forRow: <span class="hljs-number">0</span>, inSection: <span class="hljs-number">1</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Emoji</span>:
        indexPath = <span class="hljs-type">NSIndexPath</span>(forRow: <span class="hljs-number">0</span>, inSection: <span class="hljs-number">2</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-type">Lxh</span>:
        indexPath = <span class="hljs-type">NSIndexPath</span>(forRow: <span class="hljs-number">0</span>, inSection: <span class="hljs-number">3</span>)
    }
    emoticonCollectionView.scrollToItemAtIndexPath(indexPath, atScrollPosition: <span class="hljs-type">UICollectionViewScrollPosition</span>.<span class="hljs-type">Left</span>, animated: <span class="hljs-built_in">false</span>)
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<h3 id="">当滚动到某种表情页时，选中对应表情按钮</h3>
<h4 id="">实现思路</h4>
<ul>
<li>实现监听 <code>collectionView</code> 滚动的位置<ul>
<li><code>scrollView</code> 的代理方法 <code>scrollViewDidScroll</code></li>
</ul>
</li>
<li>获取到 <code>collectionView</code> 当前显示的cell (页面上最多显示两个cell)<ul>
<li><code>collectionView</code> 的 <code>visibleCells</code> 方法获取</li>
</ul>
</li>
<li>判断哪一个 <code>cell</code> 在页面显示的范围大<ul>
<li>两个 cell 的 x 值减去当前滚动的位置取绝对值，差值越小代表显示的范围越大</li>
</ul>
</li>
<li>取到这个 <code>cell</code> 对应 <code>section</code><ul>
<li><code>collectionView</code> 的 <code>indexPathForCell</code> 方法获取</li>
</ul>
</li>
<li>通过 <code>section</code> 在 <code>HMEmoticonToolBar</code> 中找到对应按钮，让其选中</li>
</ul>
<h4 id="">实现代码</h4>
<pre><code class="lang-swift"><span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">scrollViewDidScroll</span><span class="hljs-params">(scrollView: UIScrollView)</span> </span>{

    <span class="hljs-comment">// 获取到当前 `emoticonCollectionView` 显示的 cell</span>
    <span class="hljs-keyword">let</span> cells = emoticonCollectionView.visibleCells()

    <span class="hljs-comment">// 如果当前显示的是两个 cell</span>
    <span class="hljs-keyword">if</span> cells.<span class="hljs-built_in">count</span> == <span class="hljs-number">2</span> {
        <span class="hljs-comment">// 定义常量，可以赋值一次</span>
        <span class="hljs-keyword">let</span> section: <span class="hljs-type">Int</span>

        <span class="hljs-comment">// 取出两个cell 对比两个cell谁在屏幕上显示的范围多</span>
        <span class="hljs-keyword">let</span> firstCell = cells.first!
        <span class="hljs-keyword">let</span> secondCell = cells.last!

        <span class="hljs-comment">// 两个 cell 的 x 减去滚动距离，绝对值越小，显示的范围越多</span>
        <span class="hljs-keyword">let</span> firstCellR = <span class="hljs-built_in">abs</span>(<span class="hljs-type">Int32</span>(firstCell.x - scrollView.contentOffset.x))
        <span class="hljs-keyword">let</span> secondCellR = <span class="hljs-built_in">abs</span>(<span class="hljs-type">Int32</span>(secondCell.x - scrollView.contentOffset.x))

        <span class="hljs-comment">// 值越小显示的范围越大</span>
        <span class="hljs-keyword">if</span> firstCellR &lt; secondCellR {
            <span class="hljs-comment">// 前面cell显示的范围多</span>
            section = emoticonCollectionView.indexPathForCell(firstCell)!.section
        }<span class="hljs-keyword">else</span>{
            section = emoticonCollectionView.indexPathForCell(secondCell)!.section
        }
        printLog(<span class="hljs-string">"当前是第 <span class="hljs-subst">\(section)</span> 组"</span>)
    }
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<ul>
<li>在 <code>HMEmoticonToolBar</code> 中提示 <code>selectButtonWithSection</code> 方法供选中按钮方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 通过 section 选中某一个按钮</span>
<span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">selectButtonWithSection</span><span class="hljs-params">(section: Int)</span> </span>{
    <span class="hljs-comment">// 通过 section 获取到对应的 button，让其选中</span>
    <span class="hljs-keyword">let</span> button = viewWithTag(section)! <span class="hljs-keyword">as</span>! <span class="hljs-type">UIButton</span>
    childButtonClick(button)
}
</code></pre>
<ul>
<li>在 <code>HMEmoticonKeyboard</code> 的 <code>scrollViewDidScroll</code> 方法中调用此方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">scrollViewDidScroll</span><span class="hljs-params">(scrollView: UIScrollView)</span> </span>{
    ...
    emoticonToolBar.selectButtonWithSection(section)
}
</code></pre>
<blockquote>
<p>运行测试：崩溃 Could not cast value of type &#39;WeiBo.HMEmoticonToolBar&#39; (0x10bad2dc0) to &#39;UIButton&#39; (0x10dcc2320).  原因是当前 section 为 0，调用 viewWithTag 方法取到的是 toolBar 自己，强转出错，所以把每一个按钮对应的枚举值给定一个基数</p>
</blockquote>
<ul>
<li>更改表情按钮枚举定义</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">HMEmoticonType</span>: <span class="hljs-title">Int</span> </span>{
    <span class="hljs-keyword">case</span> <span class="hljs-type">Recent</span> = <span class="hljs-number">1000</span>      <span class="hljs-comment">// 最近表情</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Default</span> = <span class="hljs-number">1001</span>     <span class="hljs-comment">// 默认表情</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Emoji</span> = <span class="hljs-number">1002</span>       <span class="hljs-comment">// Emoji表情</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Lxh</span> = <span class="hljs-number">1003</span>         <span class="hljs-comment">// 浪小花表情</span>
}
</code></pre>
<ul>
<li>在调用 <code>viewWithTag</code> 方法的时候添加一个基数</li>
</ul>
<pre><code class="lang-swfit">/// 通过 section 选中某一个按钮
func selectButtonWithSection(section: Int) {
    // 通过 section 获取到对应的 button，让其选中
    let button = viewWithTag(section + 1000)! as! UIButton
    childButtonClick(button)
}
</code></pre>
<blockquote>
<p>运行测试：在从第0组滑动过一半的时候，很快速的切换到第1组表情去了，原因就是调用 <code>childButtonClick</code> 方法会执行代理方法，代理方法会回调滚动 <code>collectionView</code>，所以在这个地方只需要切换 button 选中状态</p>
</blockquote>
<ul>
<li>提取按钮切换状态的方法 <code>changeButtonState</code></li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 改变按钮状态，把当前选中的 button 取消选中，把传入的 button 设置选中</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">changeButtonState</span><span class="hljs-params">(button: UIButton)</span></span>{
    <span class="hljs-comment">// 如果当前选中的 button 与即将要选中的button相同，则直接返回</span>
    <span class="hljs-keyword">if</span> button == currentSelectedButton {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 取消选中之前的</span>
    currentSelectedButton?.selected = <span class="hljs-built_in">false</span>
    <span class="hljs-comment">// 选中现在点击的</span>
    button.selected = <span class="hljs-built_in">true</span>
    <span class="hljs-comment">// 再次记录现在选的按钮</span>
    currentSelectedButton = button
}
</code></pre>
<ul>
<li>在 <code>selectButtonWithSection</code> 调用 <code>changeButtonState</code> 方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 通过 section 选中某一个按钮</span>
<span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">selectButtonWithSection</span><span class="hljs-params">(section: Int)</span> </span>{
    <span class="hljs-comment">// 通过 section 获取到对应的 button，让其选中</span>
    <span class="hljs-keyword">let</span> button = viewWithTag(section + <span class="hljs-number">1000</span>)! <span class="hljs-keyword">as</span>! <span class="hljs-type">UIButton</span>
    <span class="hljs-comment">// 更改按钮选中状态</span>
    changeButtonState(button)
}
</code></pre>
<ul>
<li>替换 <code>childButtonClick</code> 方法内实现</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 子按钮点击</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// - parameter button: 当前点击的 button</span>
<span class="hljs-preprocessor">@objc</span> private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">childButtonClick</span><span class="hljs-params">(button: UIButton)</span></span>{
    <span class="hljs-comment">// 如果当前选中的 button 与即将要选中的button相同，则直接返回</span>
    <span class="hljs-keyword">if</span> button == currentSelectedButton {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 改变按钮状态</span>
    changeButtonState(button)

    <span class="hljs-comment">// 调用代理方法</span>
    delegate?.emoticonToolBarButtonDidSelected(<span class="hljs-type">HMEmoticonType</span>(rawValue: button.tag)!)
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<h2 id="">表情显示</h2>
<h3 id="">设置子控件</h3>
<ul>
<li>在 <code>HMEmoticonPageCell</code> 中添加 20 个按钮表情按钮</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 添加表情按钮</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">addEmoticonButtons</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">for</span> <span class="hljs-number">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-type">HMEmoticonPageNum</span> {
        <span class="hljs-keyword">let</span> button = <span class="hljs-type">UIButton</span>()
        button.backgroundColor = <span class="hljs-type">RandomColor</span>()
        contentView.addSubview(button)
        emoticonButtons.append(button)
    }
}
</code></pre>
<ul>
<li>在 <code>setupUI</code> 方法中调用此方法</li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">// 添加子控件</span>
    addEmoticonButtons()
    ...
}
</code></pre>
<ul>
<li>布局子控件</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">override</span> <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">layoutSubviews</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">super</span>.layoutSubviews()

    <span class="hljs-comment">// 求出button的宽高</span>
    <span class="hljs-keyword">let</span> childW = width / <span class="hljs-type">CGFloat</span>(<span class="hljs-type">HMEmoticonPageMaxCol</span>)
    <span class="hljs-keyword">let</span> childH = height / <span class="hljs-type">CGFloat</span>(<span class="hljs-type">HMEmoticonPageMaxRow</span>)

    <span class="hljs-comment">// 遍历调整每一个按钮的宽高</span>
    <span class="hljs-keyword">for</span> (index,value) <span class="hljs-keyword">in</span> emoticonButtons.<span class="hljs-class"><span class="hljs-keyword">enum</span><span class="hljs-title">erate</span>() </span>{

        <span class="hljs-comment">// 计算出在多少行多少列</span>
        <span class="hljs-keyword">let</span> col = index % <span class="hljs-type">HMEmoticonPageMaxCol</span>
        <span class="hljs-keyword">let</span> row = index / <span class="hljs-type">HMEmoticonPageMaxCol</span>

        <span class="hljs-comment">// 设置大小位置</span>
        value.x = <span class="hljs-type">CGFloat</span>(col) * childW
        value.y = <span class="hljs-type">CGFloat</span>(row) * childH
        value.size = <span class="hljs-type">CGSizeMake</span>(childW, childH)
    }
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<ul>
<li>懒加载删除按钮</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 删除按钮</span>
private lazy <span class="hljs-keyword">var</span> deleteButton: <span class="hljs-type">UIButton</span> = {
    <span class="hljs-keyword">let</span> deleteButton = <span class="hljs-type">UIButton</span>()
    deleteButton.setImage(<span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"compose_emotion_delete"</span>), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
    deleteButton.setImage(<span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"compose_emotion_delete_highlighted"</span>), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Highlighted</span>)
    <span class="hljs-keyword">return</span> deleteButton
}()
</code></pre>
<ul>
<li>添加删除按钮</li>
</ul>
<pre><code class="lang-swift">private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">setupUI</span><span class="hljs-params">()</span></span>{
    contentView.addSubview(deleteButton)
    ...
}
</code></pre>
<ul>
<li>在 <code>layoutSubviews</code> 方法中调整删除控制位置</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">override</span> <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">layoutSubviews</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">super</span>.layoutSubviews()
    ...
    <span class="hljs-comment">//删除按钮</span>
    deleteButton.x = width - childW
    deleteButton.y = height - childH
    deleteButton.size = <span class="hljs-type">CGSizeMake</span>(childW, childH)
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<h3 id="">显示图片表情数据</h3>
<ul>
<li>在 <code>HMEmoticonPageCell</code> 中提供 <code>emoticons</code> 属性，供外界设置表情数据</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">var</span> emoticons: [<span class="hljs-type">HMEmoticon</span>]?
</code></pre>
<ul>
<li><code>HMEmoticonKeyboard</code> 中的 <code>collectionView</code> 数据源方法里面给 cell 设置数据</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">collectionView</span><span class="hljs-params">(collectionView: UICollectionView, cellForItemAtIndexPath indexPath: NSIndexPath)</span> -&gt; <span class="hljs-title">UICollectionViewCell</span> </span>{
    <span class="hljs-keyword">let</span> cell = collectionView.dequeueReusableCellWithReuseIdentifier(<span class="hljs-type">HMEmoticonKeyboardCellId</span>, forIndexPath: indexPath) <span class="hljs-keyword">as</span>! <span class="hljs-type">HMEmoticonPageCell</span>
    cell.indexPath = indexPath
    <span class="hljs-comment">// 设置表情数据</span>
    cell.emoticons = <span class="hljs-type">HMEmoticonTools</span>.allEmoticons()[indexPath.section][indexPath.row]
    <span class="hljs-keyword">return</span> cell
}
</code></pre>
<ul>
<li>在 <code>emoticons</code> 的 <code>didSet</code> 方法中显示表情</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 当前页显示的表情数据</span>
<span class="hljs-keyword">var</span> emoticons: [<span class="hljs-type">HMEmoticon</span>]? {
    <span class="hljs-keyword">didSet</span>{
        <span class="hljs-comment">// 遍历当前设置的表情数据</span>
        <span class="hljs-keyword">for</span> (index,value) <span class="hljs-keyword">in</span> emoticons!.<span class="hljs-class"><span class="hljs-keyword">enum</span><span class="hljs-title">erate</span>() </span>{
            <span class="hljs-keyword">let</span> button = emoticonButtons[index]
            <span class="hljs-keyword">if</span> !value.isEmoji {
                <span class="hljs-keyword">let</span> image = <span class="hljs-type">UIImage</span>(named: value.png!)
                button.setImage(image, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
            }
        }
    }
}
</code></pre>
<blockquote>
<p>运行测试：表情没有显示出来，加载表情的图片地址不正确，因为表情图片是放在 <code>Emoticons.bundle</code> 中的，所以需要拼接前面的路径，而这前面的路径就是表情所对应的 <code>info.plist</code> 文件所在的路径</p>
</blockquote>
<ul>
<li>在 <code>HMEmoticon</code> 中添加 <code>path</code> 属性</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 图片表情对应的路径</span>
<span class="hljs-keyword">var</span> path: <span class="hljs-type">String</span>?
</code></pre>
<ul>
<li>在 <code>HMEmoticonTools</code> 加载表情的方法里面去设置这个值</li>
</ul>
<pre><code class="lang-swift">/// 通过表情路径加载表情数据
///
/// - parameter path: 表情路径，如：default/info.plist
private class func emoticons(path: String) -&gt; [HMEmoticon] {

    // 通过文件名或者到文字路径
    let file = emoticonBundle.pathForResource(path, ofType: nil)
    // 加载数据
    let infoArray = NSArray(contentsOfFile: file!)

    // 字典转模型
    var result = [HMEmoticon]()
    for value in infoArray! {
        if let dic = (value as? [String: AnyObject]) {
            let emoticon = HMEmoticon(dictionary: dic)
            // 设置表情所在的路径
            emoticon.path = (file! as NSString).stringByDeletingLastPathComponent
            result.append(emoticon)
        }
    }
    return result
}
</code></pre>
<ul>
<li>更新 <code>HMEmoticonPageCell</code> 中 <code>emoticons</code> 的 <code>didSet</code> 方法</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 当前页显示的表情数据</span>
<span class="hljs-keyword">var</span> emoticons: [<span class="hljs-type">HMEmoticon</span>]? {
    <span class="hljs-keyword">didSet</span>{
        <span class="hljs-comment">// 遍历当前设置的表情数据</span>
        <span class="hljs-keyword">for</span> (index,value) <span class="hljs-keyword">in</span> emoticons!.<span class="hljs-class"><span class="hljs-keyword">enum</span><span class="hljs-title">erate</span>() </span>{
            <span class="hljs-keyword">let</span> button = emoticonButtons[index]
            <span class="hljs-keyword">if</span> !value.isEmoji {
                <span class="hljs-keyword">let</span> image = <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(value.path!)</span>/<span class="hljs-subst">\(value.png!)</span>"</span>)
                button.setImage(image, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
            }
        }
    }
}
</code></pre>
<blockquote>
<p>运行测试：图片表情显示出来了，但是 <code>cell 复用</code> 导致没有表情的页面也显示过表情，所以在遍历设置表情之后需要先将所有的 <code>显示表情的button</code> 隐藏掉</p>
</blockquote>
<ul>
<li>先隐藏所有显示表情的 button，遍历几个表情显示几个</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 当前页显示的表情数据</span>
<span class="hljs-keyword">var</span> emoticons: [<span class="hljs-type">HMEmoticon</span>]? {
    <span class="hljs-keyword">didSet</span>{

        <span class="hljs-comment">// 先隐藏所有的表情按钮</span>
        <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> emoticonButtons {
            value.hidden = <span class="hljs-built_in">true</span>
        }

        <span class="hljs-comment">// 遍历当前设置的表情数据</span>
        <span class="hljs-keyword">for</span> (index,value) <span class="hljs-keyword">in</span> emoticons!.<span class="hljs-class"><span class="hljs-keyword">enum</span><span class="hljs-title">erate</span>() </span>{
            <span class="hljs-keyword">let</span> button = emoticonButtons[index]
            <span class="hljs-comment">// 显示当前遍历到的表情按钮</span>
            button.hidden = <span class="hljs-built_in">false</span>
            <span class="hljs-keyword">if</span> !value.isEmoji {
                <span class="hljs-keyword">let</span> image = <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(value.path!)</span>/<span class="hljs-subst">\(value.png!)</span>"</span>)
                button.setImage(image, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
            }
        }
    }
}
</code></pre>
<h3 id="-emoji-">显示 Emoji 表情数据</h3>
<ol>
<li>拖入 <code>NSString+Emoji</code> 分类到项目中，在 <code>WeiBo-Bridging-Header.h</code> 文件中引入 <code>NSString+Emoji.h</code></li>
<li>Emoji 表情其实就是字符串</li>
</ol>
<ul>
<li>设置 <code>Emoji</code> 表情数据</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">if</span> !value.isEmoji {
    <span class="hljs-keyword">let</span> image = <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(value.path!)</span>/<span class="hljs-subst">\(value.png!)</span>"</span>)
    button.setImage(image, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
}<span class="hljs-keyword">else</span>{
    button.setTitle((value.code! <span class="hljs-keyword">as</span> <span class="hljs-type">NSString</span>).emoji(), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
}
</code></pre>
<blockquote>
<p>运行测试：在显示 <code>emoji</code> 表情的时候左边有图片表情，因为复用的问题</p>
</blockquote>
<ul>
<li>在设置 emoji 表情的时候把按钮的图片清空，设置图片表情的时候把按钮的文字清空。</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-keyword">if</span> !value.isEmoji {
    <span class="hljs-keyword">let</span> image = <span class="hljs-type">UIImage</span>(named: <span class="hljs-string">"<span class="hljs-subst">\(value.path!)</span>/<span class="hljs-subst">\(value.png!)</span>"</span>)
    button.setImage(image, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
    button.setTitle(<span class="hljs-built_in">nil</span>, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
}<span class="hljs-keyword">else</span>{
    button.setImage(<span class="hljs-built_in">nil</span>, forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
    button.setTitle((value.code! <span class="hljs-keyword">as</span> <span class="hljs-type">NSString</span>).emoji(), forState: <span class="hljs-type">UIControlState</span>.<span class="hljs-type">Normal</span>)
}
</code></pre>
<ul>
<li>运行测试：Emoji 表情显示太小，调整 button 的文字大小即可解决</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 添加表情按钮</span>
private <span class="hljs-func"><span class="hljs-keyword">func</span> <span class="hljs-title">addEmoticonButtons</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">for</span> <span class="hljs-number">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;<span class="hljs-type">HMEmoticonPageNum</span> {
        <span class="hljs-keyword">let</span> button = <span class="hljs-type">UIButton</span>()
        button.titleLabel?.font = <span class="hljs-type">UIFont</span>.systemFontOfSize(<span class="hljs-number">36</span>)
        contentView.addSubview(button)
        emoticonButtons.append(button)
    }
}
</code></pre>
<blockquote>
<p>运行测试</p>
</blockquote>
<ul>
<li>更改 <code>HMEmoticonKeyboard</code> 中的 <code>collectionView</code> 的背景颜色为透明色</li>
</ul>
<pre><code class="lang-swift"><span class="hljs-comment">/// 显示表情的视图</span>
private lazy <span class="hljs-keyword">var</span> emoticonCollectionView: <span class="hljs-type">UICollectionView</span> = {
    ...
    collectionView.backgroundColor = <span class="hljs-type">UIColor</span>.clearColor()
    ...
    <span class="hljs-keyword">return</span> collectionView
}()
</code></pre>
<ul>
<li>去掉 <code>HMEmoticonPageCell</code> 中显示 section 的 label</li>
</ul>
<blockquote>
<p>运行测试</p>
</blockquote>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../composeviewcontroller/composeviewcontroller-02-selectedpicture.html" class="navigation navigation-prev " aria-label="Previous page: 选择图片"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../composeviewcontroller/composeviewcontroller-04-nsattributedstring.html" class="navigation navigation-next " aria-label="Next page: 图文混排"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
